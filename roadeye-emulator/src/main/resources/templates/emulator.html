<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>차량 시뮬레이터</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        button { margin: 5px; padding: 10px 20px; }
        textarea { width: 100%; height: 300px; margin-top: 20px; }
    </style>
</head>
<body>
<h1>차량 데이터 시뮬레이터</h1>
<button onclick="sendIgnition('ON')">시동 ON</button>
<button onclick="startDriving()">주행 시작</button>
<button onclick="sendIgnition('OFF')">시동 OFF</button>
<textarea id="log" readonly></textarea>

<script>
    const vehicleId = "TEST-1234";
    let ignitionTime = null;
    let cumulativeDistance = 0;
    let gpsStatus = "A";
    let driving = false;
    let driveData = [];
    let lastLat = 37.5665;
    let lastLon = 126.9780;
    let drivingInterval = null;

    let lastShutdownData = null; // { lat, lon, sum } / 마지막 시동 OFF 시 좌표(lat, lon)와 누적거리(sum)를 저장.

    const commonFields = {
        tid: "A001",
        mid: "6",
        pv: "5",
        did: "1"
    };

    function log(msg) {
        const logArea = document.getElementById("log");
        logArea.value += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        logArea.scrollTop = logArea.scrollHeight;
    }

    function sendRequest(url, body) {
        const headers = {
            "Content-Type": "application/json; charset=utf-8",
            "Accept": "application/json; charset=utf-8",
            "Cache-Control": "no-cache",
            "Accept-Encoding": "gzip, deflate",
            "Timestamp": new Date().toISOString(),
            "TUID": crypto.randomUUID(),
            "Key-Version": "1.0",
            "Token": "test-token"
        };

        log(`POST to ${url}:\n${JSON.stringify(body, null, 2)}`);
        fetch(url, {
            method: "POST",
            headers: headers,
            body: JSON.stringify(body)
        }).then(res => log(`응답 상태: ${res.status}`));
    }

    function formatTime(date) {
        return date.getFullYear().toString().padStart(4, '0') +
            (date.getMonth() + 1).toString().padStart(2, '0') +
            date.getDate().toString().padStart(2, '0') +
            date.getHours().toString().padStart(2, '0') +
            date.getMinutes().toString().padStart(2, '0') +
            date.getSeconds().toString().padStart(2, '0'); // 현재 시간 초
    }

    function sendIgnition(type) {
        const now = new Date();
        const onTime = ignitionTime || formatTime(now);
        const offTime = formatTime(now);

        if (type === "OFF" && driving) {
            clearInterval(drivingInterval);
            driving = false;

            if (driveData.length > 0) {
                const body = {
                    ...commonFields,
                    mdn: vehicleId,
                    oTime: formatTime(now).slice(0, 12),
                    cCnt: driveData.length,
                    cList: driveData
                };
                sendRequest("/api/driving", body);
                driveData = [];
            }

            lastShutdownData = {
                lat: lastLat,
                lon: lastLon,
                sum: cumulativeDistance
            };

            log("주행 종료 (시동 OFF로 종료)");
        }


        const payload = {
            ...commonFields,
            mdn: vehicleId,
            onTime: type === 'ON' ? onTime : ignitionTime,
            offTime: type === 'OFF' ? offTime : '',
            gcd: gpsStatus,
            lat: lastLat.toFixed(6),
            lon: lastLon.toFixed(6),
            sum: Math.floor(cumulativeDistance)
        };

        if (type === "ON") {
            ignitionTime = onTime;

            if (lastShutdownData) {
                const distanceFromLast = getDistance(
                    lastShutdownData.lat,
                    lastShutdownData.lon,
                    lastLat,
                    lastLon
                );

                if (distanceFromLast < 80) {
                    cumulativeDistance = lastShutdownData.sum + distanceFromLast;
                } else {
                    log(`🟡 시동 ON 거리 (${Math.round(distanceFromLast)}m)가 80m 초과로 무시됨`);
                    cumulativeDistance = lastShutdownData.sum;
                }
            }

            sendRequest("/api/ignition/on", payload);
        }

    }

    function startDriving() {
        if (!ignitionTime) {
            log("⚠️ 시동이 먼저 켜져야 합니다.");
            return;
        }

        if (driving) {
            log("⚠️ 이미 주행 중입니다.");
            return;
        }

        driving = true;
        driveData = [];
        log("🚗 주행 시작");

        drivingInterval = setInterval(() => {
            const now = new Date();
            const sec = now.getSeconds().toString().padStart(2, '0');

            lastLat += 0.0001;
            lastLon += 0.0001;

            const spd = Math.floor(Math.random() * 20) + 30;
            const distance = (spd * 1000 / 3600);
            cumulativeDistance += distance;

            driveData.push({
                sec: sec,
                gcd: gpsStatus,
                lat: lastLat.toFixed(6),
                lon: lastLon.toFixed(6),
                spd: spd,
                sum: Math.floor(cumulativeDistance)
            });

            if (driveData.length === 60) {
                const body = {
                    ...commonFields,
                    mdn: vehicleId,
                    oTime: formatTime(now).slice(0, 12),
                    cCnt: 60,
                    cList: driveData
                };
                sendRequest("/api/driving", body);
                driveData = [];
            }
        }, 1000);
    }
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // 지구 반지름 (m)
        const toRad = x => x * Math.PI / 180;
        const dLat = toRad(lat2 - lat1);
        const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2) ** 2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }
</script>

</body>
</html>
